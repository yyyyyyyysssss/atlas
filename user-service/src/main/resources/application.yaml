server:
  port: 9091
  tomcat:
    threads:
      max: 200

spring:
  application:
    name: user-service
  main:
    allow-circular-references: true
  servlet:
    multipart:
      enabled: true
      max-file-size: 20MB
      max-request-size: 20MB
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
  mvc:
    async:
      request-timeout: -1
    pathmatch:
      matching-strategy: ant_path_matcher
  output:
    ansi:
      enabled: always
  threads:
    virtual:
      enabled: true
  cloud:
    circuitbreaker:
      resilience4j:
        disable-thread-pool: true
    openfeign:
      circuitbreaker:
        enabled: true
      client:
        config:
          default:
            loggerLevel: basic
      httpclient:
        hc5:
          enabled: true


logging:
  level:
    com.atlas.common.core.api.notification.feign: DEBUG

mybatis-plus:
  mapper-locations: classpath:mapper/*xml
  configuration:
    map-underscore-to-camel-case: true


# 使用resilience4j 熔断降级配置
resilience4j:
  scheduled:
    executor:
      context-propagators:
        - com.atlas.common.core.resilience4j.MdcContextPropagator
  # 断路器
  circuitbreaker:
    configs:
      default:
        failureRateThreshold: 50 #以百分⽐配置失败率阈值。当失败率等于或⼤于阈值时，断路器状态并关闭变为开启，并进⾏服务降级
        slidingWindowSize: 10 #滑动窗⼝的⼤⼩ 配置COUNT_BASED,表示n个请求，配置TIME_BASED表示n秒
        minimumNumberOfCalls: 8 #断路器计算失败率或慢调⽤率之前所需的最⼩调⽤数（每个滑动窗⼝周期）
        slidingWindowType: TIME_BASED #滑动窗⼝类型是COUNT_BASED，将会统计记录最近slidingWindowSize次调⽤的结果。如果是TIME_BASED，将会统计记录最近 slidingWindowSize秒的调⽤结果
        permittedNumberOfCallsInHalfOpenState: 10 #断路器在半开状态下允许通过的调⽤次数。
        waitDurationInOpenState: 2s # 断路器从开启过渡到半开应等待的时间
        registerHealthIndicator: true # 健康监测
        automaticTransitionFromOpenToHalfOpenEnabled: false # 是否自动从打开到半开，不需要触发 设置为false，则只有在发出调⽤时才会转换到半开
        recordExceptions: #记录为失败并因此增加失败率的异常列表。除⾮通过ignoreExceptions显式忽略，否则与列表中某个匹配或继承的异常都将被视为失败。 如果指定异常列表，则所有其他异常均视为成功，除⾮它们被ignoreExceptions显式忽略
          - java.lang.Exception
        ignore-exceptions:
          - com.atlas.common.core.exception.BusinessException
    instances:
      # 公共断路器: 单位窗口时间10秒内最低8个请求有百分之50的请求都是异常的时 触发该断路器
      commonBreaker:
        base-config: default #继承默认配置default
      # 慢调用断路器: 单位窗口时间10秒内最低8个请求有百分之30调用时间都是超过3秒时 触发该断路器
      slowCallBreaker:
        failureRateThreshold: 50
        slowCallDurationThreshold: 3s #慢调⽤时间阈值，⾼于这个阈值的呼叫视为慢调⽤，并增加慢调⽤⽐例。
        slowCallRateThreshold: 30 #以百分⽐的⽅式配置，断路器把调⽤时间⼤于slowCallDurationThreshold的调⽤视为慢调⽤，当慢调⽤⽐例⼤于等于阈值时，断路器开启，并进⾏服务降级
        minimumNumberOfCalls: 8
        slidingWindowSize: 10
        slidingWindowType: TIME_BASED
        permittedNumberOfCallsInHalfOpenState: 10
        waitDurationInOpenState: 2s #从OPEN到HALF_OPEN状态需要等待的时间
  # 限时器
  timelimiter:
    configs:
      default:
        timeoutDuration: 5s
        cancelRunningFuture: true
    instances:
      AppFuse:
        # 公共限时: 5秒
        base-config: default
  # 限速器
  ratelimiter:
    configs:
      default:
        # 如果没有令牌，最多等待时间
        timeoutDuration: 500ms
        # 限流刷新周期
        limitRefreshPeriod: 1s
        # 限流周期内允许的请求数
        limitForPeriod: 2000
    instances:
      # 验证码限流: 60秒允许1个请求，触发限流时客户端不等待直接响应
      verificationCodeLimiter:
        limitRefreshPeriod: 60s
        limitForPeriod: 1
        timeoutDuration: 0
      # 公共限流: 1秒允许2000个请求，触发限流时客户端等待10ms响应
      commonRateLimiter:
        base-config: default
  # 重试器
  retry:
    configs:
      default:
        maxAttempts: 3
        waitDuration: 500ms
        retryExceptions:
          - com.atlas.common.core.exception.RetryException
    instances:
      # 公共重试器: 当抛出RetryException异常时进行重试，重试3次，间隔500毫秒
      commonRetry:
        base-config: default
  # 信号量并发限制器
  bulkhead:
    configs:
      default:
        maxConcurrentCalls: 50
        maxWaitDuration: 100ms
    instances:
      # 公共并发限制器: 最多允许50个并发 达到限制时客户端等待100ms仍未获取资源后进行降级
      commonBulkhead:
        base-config: default
  # 线程池限制器
  thread-pool-bulkhead:
    configs:
      default:
        coreThreadPoolSize: 10
        maxThreadPoolSize: 50
        queueCapacity: 1000
        keepAliveDuration: 20ms
        context-propagators:
          - com.atlas.common.core.resilience4j.MdcContextPropagator
    instances:
      commonThreadPoolBulkhead:
        # 公共线程池限制器: 线程池耗尽时进行降级
        base-config: default

management:
  health:
    mail:
      enabled: false
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always
  info:
    os:
      enabled: true
    env:
      enabled: true

pagehelper:
  helper-dialect: mysql
  reasonable: true
  support-methods-arguments: true

http:
  config:
    # 连接池中允许存在的最大 HTTP 连接总数（整个 JVM 进程共享）
    maxConnTotal: 500
    # 单个目标主机（同一域名 + 端口）的最大并发连接数
    maxConnPerRoute: 100
    # 从连接池中获取连接的最大等待时间 单位：秒
    connectionRequestTimeout: 5
    # 建立连接后，等待服务端返回数据的最大时间（Socket 超时） 单位：秒
    responseTimeout: 60
    # 是否跳过 HTTPS 证书校验（仅限 dev/test，生产必须为 false）
    insecureSkipVerify: true
    # HTTP 代理地址
    proxy:
